#!/bin/bash
# Wrapper for wifi-location that launches it properly via macOS LaunchServices
# This is required for Location Services authorization on macOS Sequoia

OUTPUT_FILE="/tmp/wifi-location-$$.txt"
trap "rm -f '$OUTPUT_FILE'" EXIT

# Launch app bundle via open (required for Location Services auth)
env OUTPUT_FILE="$OUTPUT_FILE" open ~/Applications/wifi-location.app --args "$@"

# Wait for output file (max 3 seconds for fast mode, 20 seconds for --location)
max_wait=30
if [[ "$*" == *"--location"* ]]; then
    max_wait=200  # 20 seconds for location mode
fi

for i in $(seq 1 $max_wait); do
    if [ -f "$OUTPUT_FILE" ]; then
        cat "$OUTPUT_FILE"
        exit 0
    fi
    sleep 0.1
done

# Timeout - return empty result
echo "||"
exit 1
